<HTML>
<BODY>
<PRE>
<!-- Manpage converted by man2html 3.0.1 -->
       ipfw - IP firewall and accounting


</PRE>
<H2>SYNOPSIS</H2><PRE>
       <B>#include</B> <B>&lt;sys/types.h&gt;</B>
       <B>#include</B> <B>&lt;sys/socket.h&gt;</B>
       <B>#include</B> <B>&lt;netinet/in.h&gt;</B>
       <B>#include</B> <B>&lt;linux/ip.h&gt;</B>
       <B>#include</B> <B>&lt;linux/tcp.h&gt;</B>
       <B>#include</B> <B>&lt;linux/udp.h&gt;</B>
       <B>#include</B> <B>&lt;linux/icmp.h&gt;</B>
       <B>#include</B> <B>&lt;linux/if.h&gt;</B>
       <B>#include</B> <B>&lt;linux/ip_fw.h&gt;</B>

       <B>int</B>  <B>setsockopt</B> <B>(int</B> <I>socket</I><B>,</B> <B>IPPROTO_IP,</B> <B>int</B> <I>command</I><B>,</B> <B>void</B>
       <B>*</B><I>data</I><B>,</B> <B>int</B> <I>length</I><B>)</B>


</PRE>
<H2>DESCRIPTION</H2><PRE>
       The IP firewall and accounting  facilities  in  the  Linux
       kernel  provide  mechanisms for accounting IP packets, for
       building firewalls based on  packet-level  filtering,  for
       building  firewalls  using  transparent  proxy servers (by
       redirecting packets to local sockets), and for  masquerad-
       ing  forwarded packets.  The administration of these func-
       tions is maintained in the kernel  as  4  separate  lists,
       each  containing  zero  or more rules.  Each rule contains
       specific  information   about   source   and   destination
       addresses, protocols, port numbers, and some other charac-
       teristics.  A packet will match with a rule when the char-
       acteristics of the rule match those of the IP packet.  The
       4 categories of rules are:

       Accounting
              The accounting rules are used for  all  IP  packets
              that are sent or received via one of the local net-
              work interfaces.  Every  packet  will  be  compared
              with  all  rules in this list, and every match will
              cause an increment of the packet and byte  counters
              associated with that rule.

       Input firewall
              These  rules regulate the acceptance of incoming IP
              packets.  All packets coming  in  via  one  of  the
              local  network  interfaces  are checked against the
              input firewall rules.  The first rule that  matches
              with a packet determines the policy to use and will
              also cause the rule's packet en byte counters being
              adapted.   When  no  matching  rule  is  found, the
              default policy for the input firewall is used.

       Output firewall
              These rules define the permissions for  sending  IP
              packets.   All packets that are ready to be be sent
              that matches with a packet determines the policy to
              use  and will also cause the rule's packet and byte
              counters being adapted.  When no matching  rule  is
              found,  the  default policy for the output firewall
              is used.

       Forwarding firewall
              These rules define the permissions  for  forwarding
              IP packets.  All packets sent by a remote host hav-
              ing another remote host as destination are  checked
              against  the  forwarding firewall rules.  The first
              rule that matches with a packet determines the pol-
              icy  to  use  and will also cause the rule's packet
              and byte counters being adapted.  When no  matching
              rule  is found, the default policy for the forward-
              ing firewall is used.

       Each of the firewall rules (not the accounting rules) con-
       tains  a  policy,  which  specifies  what action has to be
       taken when a packet matches with the rule.   There  are  3
       different  policies  possible: <I>accept</I> (let the packet pass
       the firewall), <I>reject</I> (do not accept the packet  and  send
       an  ICMP  host  unreachable  message back to the sender as
       notification), and <I>deny</I> (ignore the packet without sending
       any  notification).   For  all  3 types of firewalls there
       also exists a default policy, which applies to all packets
       for which none of the rules match.

       The  input rules also define whether or not packets should
       be redirected to a local socket after  being  accepted  by
       the  input  firewall.   In  this  case, the packet will be
       received by a local  process,  even  if  it  was  sent  to
       another  host  and/or  another port number.  This function
       only applies to TCP or UDP packets.

       The forwarding rules also define whether  or  not  packets
       should be masqueraded when being forwarded.  In that case,
       the sender address in the IP packets is  replaced  by  the
       address  of  the local host and the source port in the TCP
       or UDP header is replaced by a locally  generated  (tempo-
       rary)  port  number  before being forwarded.  Because this
       administration is kept  in  the  kernel,  reverse  packets
       (sent  to the temporary port number on the local host) are
       recognized automatically.   The  destination  address  and
       port number of these packets will be replaced by the orig-
       inal address and port number that was saved when the first
       packet was masqueraded.  This function only applies to TCP
       or UDP packets.

       This paragraph describes the way a packet goes through the
       firewall  and  accounting rules.  Packets received via one
       of the local network interface  will  pass  the  following
              <I>input</I> <I>firewall</I> (incoming device)
       Here,  the  device  (network  interface) that is used when
       trying to match a rule with an IP packet is listed between
       brackets.   After  this  step, a packet will optionally be
       redirected to a local socket.  When a  packet  has  to  be
       forwarded to a remote host, it will also pass the next set
       of rules:
              <I>forwarding</I> <I>firewall</I> (outgoing device)
       After this step, a packet will optionally be  masqueraded.
       Responses  to masqueraded packets will never pass the for-
       warding firewall (but they will pass both  the  input  and
       output  firewalls).  All packets sent via one of the local
       network interfaces, either locally generated or being for-
       warded, will pass the following sets of rules:
              <I>output</I> <I>firewall</I> (outgoing device)
              <I>accounting</I> (outgoing device)
       Note  that  masqueraded packets will pass the output fire-
       wall and accounting rules  with  the  new  packet  headers
       (after  passing the input and forwarding firewall with the
       original headers).  Also, responses to masqueraded packets
       will  have  different  headers  when passing the input and
       output firewall rules.

       The firewall and accounting administration can be  changed
       via  calls  to  <B>setsockopt(2)</B>.   The existing rules can be
       inspected by looking at 4 files in  the  <I>/proc/net</I>  direc-
       tory:  <I>ip</I><B>_</B><I>acct</I>,  <I>ip</I><B>_</B><I>input</I>, <I>ip</I><B>_</B><I>output</I>, and <I>ip</I><B>_</B><I>forward</I>.  The
       current administration related to masqueraded sessions can
       be  found  in the file <I>ip</I><B>_</B><I>masquerade</I> in the same directory
       (note that the rules specifying which sessions  should  be
       masqueraded are in <I>ip</I><B>_</B><I>forward</I>).


</PRE>
<H2>COMMANDS</H2><PRE>
       Commands  for  changing  the lists of rules or the default
       policies have to be given as options to the  <B>setsockopt(2)</B>
       system  call,  working  on a raw IP socket.  Most commands
       require some additional data to be passed.  A  pointer  to
       this  data and the length of the data are passed as option
       value and option length arguments to <I>setsockopt</I>.  The fol-
       lowing commands are available:

       <B>IP_ACCT_APPEND</B>
       <B>IP_FW_APPEND_IN</B>
       <B>IP_FW_APPEND_OUT</B>
       <B>IP_FW_APPEND_FWD</B>
              Add  a  rule  to  one of the accounting or firewall
              lists.  Depending on the command, the rule is added
              to  the list for accounting, input firewall, output
              firewall, or forwarding firewall, repectively.  The
              new  rule  rule is appended to the end of the list.
              The data passed  with  this  command  is  an  <I>ip</I><B>_</B><I>fw</I>
              structure, defining the contents of the new rule.

       <B>IP_FW_INSERT_IN</B>
       <B>IP_FW_INSERT_OUT</B>
       <B>IP_FW_INSERT_FWD</B>
              These  commands  are  equal to the append commands,
              except that the new rule is inserted at the  begin-
              ning of the list.

       <B>IP_ACCT_DELETE</B>
       <B>IP_FW_DELETE_IN</B>
       <B>IP_FW_DELETE_OUT</B>
       <B>IP_FW_DELETE_FWD</B>
              Remove  a  rule from one of the accounting or fire-
              wall lists.  Depending on  the  command,  the  rule
              will be removed from the list for accounting, input
              firewall, output firewall, or forwarding  firewall,
              repectively.   The data passed with this command is
              an <I>ip</I><B>_</B><I>fw</I> structure, defining the  contents  of  the
              rule  to  be removed.  The first rule conforming to
              the given definition is removed from the list.

       <B>IP_ACCT_ZERO</B>
       <B>IP_FW_ZERO_IN</B>
       <B>IP_FW_ZERO_OUT</B>
       <B>IP_FW_ZERO_FWD</B>
              Reset the packet and byte counters in all rules  of
              the  list  for  accounting,  input firewall, output
              firewall,  or  forwarding  firewall,   repectively.
              Note  that  a  (dummy)  integer has to be passed as
              data with this command.  See also  the  description
              of the <I>/proc/net</I> files for a way to atomically list
              and reset the counters.

       <B>IP_ACCT_FLUSH</B>
       <B>IP_FW_FLUSH_IN</B>
       <B>IP_FW_FLUSH_OUT</B>
       <B>IP_FW_FLUSH_FWD</B>
              Remove all rules  from  the  list  for  accounting,
              input  firewall,  output  firewall,  or  forwarding
              firewall, repectively.  Note that a (dummy) integer
              has to be passed as data with this command.

       <B>IP_FW_POLICY_IN</B>
       <B>IP_FW_POLICY_OUT</B>
       <B>IP_FW_POLICY_FWD</B>
              Change  the  default policy for the input firewall,
              output firewall, or the forwarding  firewall.   The
              new  policy is passed as integer data with the fol-
              lowing possible values:  <B>IP_FW_F_ACCEPT</B>  (accept  a
              packet),  <B>IP_FW_F_ICMPRPL</B> (reject a packet by send-
              ing an ICMP host unreachable message  back  to  the
              sender),  or  0 (deny a packet, without any further
              notification).  The policy is used when none of the
              warding  firewall,  the  given  policy  may also be
              <B>IP_FW_F_ACCEPT</B> <B>|</B> <B>IP_FW_F_MASQ</B> (R)(accept  a  packet
              to  be forwarded, but also use masquerading for TCP
              and UDP packets).

       <B>IP_FW_MASQ_TIMEOUTS</B>
              Set the timeout values used for masquerading.   The
              data  passed  with this command is a structure con-
              taining 3 fields  of  type  <I>int</I>,  representing  the
              timeout  values  (in  jiffies, 1/HZ second) for TCP
              sessions,  TCP  sessions  after  receiving  a   FIN
              packet,  and  UDP  packets, repectively.  A timeout
              value 0 means that the current timeout value of the
              corresponding entry is preserved.

       <B>IP_FW_CHECK_IN</B>
       <B>IP_FW_CHECK_OUT</B>
       <B>IP_FW_CHECK_FWD</B>
              Check  whether  a packet would be accepted, denied,
              or rejected by the input firewall (<B>IP_FW_CHECK_IN</B>),
              the  output firewall (<B>IP_FW_CHECK_OUT</B>), or the for-
              warding  firewall  (<B>IP_FW_CHECK_FWD</B>).    The   data
              passed  with this command is an <I>ip</I><B>_</B><I>fwpkt</I> structure,
              defining  the  packet  headers  and  the  interface
              address.


</PRE>
<H2>STRUCTURES</H2><PRE>
       The <I>ip</I><B>_</B><I>fw</I> structure contains the following relevant fields
       to be filled in for adding or deleting a rule:

       struct in_addr fw_src, fw_dst
              Source and destination IP addresses.

       struct in_addr fw_smsk, fw_dmsk
              Masks for the source and destination IP  addresses.
              Note  that a mask of 0.0.0.0 will result in a match
              for all hosts.

       struct in_addr fw_via
              IP address of the interface via which a  packet  is
              received  by  the  system or is going to be sent by
              the system.  The  address  0.0.0.0  has  a  special
              meaning:   it   will   match   with  all  interface
              addresses.

       char fw_vianame[IFNAMSIZ]
              Name  of  the  interface  via  which  a  packet  is
              received  by  the  system or is going to be sent by
              the system.  The empty string has a  special  mean-
              ing: it will match with all device names.

       unsigned short fw_flg

              The  protocol  (mandatory).   Possible  values  are
              <B>IP_FW_F_TCP</B>  (TCP), <B>IP_FW_F_UDP</B> (UDP), <B>IP_FW_F_ICMP</B>
              (ICMP),  or  <B>IP_FW_F_ALL</B>  (all   protocols,   which
              defines a universal firewall/accounting rule).

              The  policy  to  be used when a packet matches with
              this  rule.   This  policy  can  be  <B>IP_FW_F_ACCEPT</B>
              (accept  the  packet),  <B>IP_FW_F_ICMPRPL</B> (reject the
              packet by sending an ICMP host unreachable  message
              back  to  the sender).  When none of these flags is
              specified, the packet is denied without any notifi-
              cation.    Note  that  the  policy  is  ignored  in
              accounting rules.

              Redirection and masquerading are also defined  with
              2   flags.   <B>IP_FW_F_REDIR</B>  redirects  an  accepted
              packet to a local socket (specified by a port  num-
              ber,  see  below).  It is only valid in input fire-
              wall rules and can only be used when the kernel  is
              compiled  with <B>CONFIG_IP_TRANSPARENT_PROXY</B> defined.
              <B>IP_FW_F_MASQ</B> masquerades an accepted packet.  It is
              only  valid  in  forwarding  firewall rules and can
              only be used when the kernel is compiled with  <B>CON-</B>
              <B>FIG_IP_MASQUERADE</B> defined.

              The other options are: <B>IP_FW_F_BIDIR</B> (bidirectional
              rule, matching in both directions),  <B>IP_FW_F_TCPACK</B>
              (only  matches with TCP packets when the ACK bit is
              set in the TCP header, ignored  with  other  proto-
              cols),  <B>IP_FW_F_TCPSYN</B> (only matches with TCP pack-
              ets when the SYN bit is set  and  the  ACK  bit  is
              cleared  in the TCP header, ignored with other pro-
              tocols), <B>IP_FW_F_ACCTIN</B> and  <B>IP_FW_F_ACCTOUT</B>  (only
              match  incoming  or outgoing packets, respectively;
              these  options  only  have  effect  in   accounting
              rules),  <B>IP_FW_F_SRNG</B>,  and <B>IP_FW_F_DRNG</B> (see below
              for a description  of  these  flags).   The  option
              <B>IP_FW_F_PRN</B>  can  be  used to list some information
              about a matching packet via <I>printk</I>().  This  option
              will  only be effective when the kernel is compiled
              with <B>CONFIG_IP_FIREWALL_VERBOSE</B> defined.

       unsigned short fw_nsp, fw_ndp, fw_pts[IP_FW_MAX_PORTS]
              These fields specify the number  of  source  ports,
              the  number  of destination ports, and the array in
              which these ports are  stored,  respectively.   The
              array  starts  with the source ports, directly fol-
              lowed by the  destination  ports.   If  the  option
              <B>IP_FW_F_REDIR</B>  is used, these ports are followed by
              the redirection port.  If this redirection port  is
              0, the destination port of a packet will be used as
              the list of source and destination ports  may  con-
              tain  at most one range.  In that case, the first 2
              port numbers of the list are taken as  the  minimum
              and maximum values of the range.  For ICMP packets,
              source ports are interpreted as ICMP types and des-
              tination ports are ignored.  Because the second and
              further fragments of a TCP or  UDP  packet  do  not
              contain  port numbers, these IP packets are treated
              in accounting rules as if  both  port  numbers  are
              equal  to  65535.   For the same reason, all second
              and further fragments of an ICMP packet are treated
              in  accounting rules as if the ICMP message type is
              255.  Furthermore, all second and further fragments
              of  TCP,  UDP,  or ICMP packets will be accepted by
              any of the 3 firewalls.  The flags <B>IP_FW_F_SRNG</B> and
              <B>IP_FW_F_DRNG</B> in the <I>fw</I><B>_</B><I>flg</I> field specify whether or
              not a source and/or destination range is specified.

       unsigned char fw_tosand, fw_tosxor
              These  8-bit  masks define how the TOS field in the
              IP header  should  be  changed  when  a  packet  is
              accepted  by  the  firewall rule.  The TOS field is
              first bitwise and'ed with <I>fw</I><B>_</B><I>tosand</I> and the  result
              of this will be bitwise xor'ed with <I>fw</I><B>_</B><I>tosxor</I>.  The
              fields are ignored in accounting rules or in  fire-
              wall rules for rejecting or denying a packet.

       The  <I>ip</I><B>_</B><I>fwpkt</I> structure, used when checking a packet, con-
       tains the following fields:

       struct iphdr fwp_iph
              The IP header.  See  <I>&lt;linux/ip.h&gt;</I>  for  a  detailed
              description of the <I>iphdr</I> structure.

       struct tcphdr fwp_protoh.fwp_tcph
       struct udphdr fwp_protoh.fwp_udph
       struct icmphdr fwp_protoh.fwp_icmph
              The  TCP,  UDP, or ICMP header, combined in a union
              named     <I>fwp</I><B>_</B><I>protoh</I>.       See      <I>&lt;linux/tcp.h&gt;</I>,
              <I>&lt;linux/udp.h&gt;</I>,  or  <I>&lt;linux/icmp.h&gt;</I>  for  a detailed
              description of the respective structures.

       struct in_addr fwp_via
              The interface address via which the packet is  pre-
              tended to be received or sent.


</PRE>
<H2>RETURN VALUE</H2><PRE>
       On  success,  zero  is returned.  On error, -1 is returned
       and <I>errno</I> is set appropriately.  See <B>setsockopt(2)</B>  for  a
       list  of  possible  error values.  When one of the 2 check
       packet commands is used, zero is returned when the  packet
       would  be  accepted  without  redirection or masquerading.
       (packet would be accepted using  masquerading),  <B>ETIMEDOUT</B>
       (packet would be denied), or <B>ECONNREFUSED</B> (packet would be
       rejected).


</PRE>
<H2>LISTING RULES</H2><PRE>
       In the directory <I>/proc/net</I> there are 4 entries to list the
       currently  defined  rules  for  each  of  the  categories:
       <I>ip</I><B>_</B><I>acct</I> (for IP accounting rules), <I>ip</I><B>_</B><I>input</I> (for IP  input
       firewall rules), <I>ip</I><B>_</B><I>output</I> (for IP output firewall rules),
       and <I>ip</I><B>_</B><I>forward</I> (for IP forwarding firewall rules).   Read-
       ing  these files results in a header line and one line for
       each defined rule.  For  all  3  types  of  firewall,  the
       header  line  includes at the end a decimal representation
       of   the   corresponding   default    policy    (one    of
       <B>IP_FW_F_ACCEPT</B>,  <B>IP_FW_F_ICMPRPL</B>, and 0; the policy of the
       forwarding  firewall  may   also   be   <B>IP_FW_F_ACCEPT</B>   <B>|</B>
       <B>IP_FW_F_MASQ</B>).

       Each  following  line  lists the contents of a rule in the
       following order:  source  address  and  mask,  destination
       address  and  mask,  interface  address,  flags, number of
       source and destination ports, packet  and  byte  counters,
       the  list  of  ports,  a TOS and-mask, and a TOS xor-mask.
       The IP addresses and masks are  listed  as  8  hexadecimal
       digits,  the  TOS masks are listed as 2 hexadecimal digits
       preceeded by the letter A  and  X,  repectively,  and  the
       other  values are represented in decimal format.  Individ-
       ual fields are seperated by white space,  by  a  '/'  (the
       address  and  the  corresponding  mask),  or  by "-&gt;" (the
       source and destination address/mask pairs).

       The files may also be opened in read/write mode (only root
       is allowed to do this).  In that case, the packet and byte
       counters in all the rules of that category will  be  reset
       to zero after listing their current values.

       The   file  <I>/proc/net/ip</I><B>_</B><I>masquerade</I>  contains  the  kernel
       administration related to masquerading.   After  a  header
       line,  each masqueraded session is described on a separate
       line with the following entries, separated by white  space
       or  by  ':' (the address/port number pairs): protocol name
       ("TCP" or "UDP"), source IP address and port number,  des-
       tination  IP address and port number, the new port number,
       the initial sequence number for adding a delta value,  the
       delta value, the previous delta value, and the expire time
       in jiffies (1/HZ second).  All addresses and numeric  val-
       ues  are in hexadecimal format, except the last 3 entries,
       being represented in decimal format.


</PRE>
<H2>FILES</H2><PRE>
       <I>/proc/net/ip</I><B>_</B><I>acct</I>
       <I>/proc/net/ip</I><B>_</B><I>input</I>
       <I>/proc/net/ip</I><B>_</B><I>masquerade</I>


</PRE>
<H2>SEE ALSO</H2><PRE>
       <B>setsockopt(2)</B>, <B>socket(2)</B>, <B>ipfwadm(8)</B>

</PRE>
<HR>
<ADDRESS>
Man(1) output converted with
<a href="http://www.oac.uci.edu/indiv/ehood/man2html.html">man2html</a>
</ADDRESS>
</BODY>
</HTML>
